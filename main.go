package main

import (
	"encoding/hex"
	"ethereum-evm/core/vm"
	"math/big"

	"github.com/ethereum/go-ethereum/common"

	"ethereum-evm/core/state"
	"fmt"
)

// common.HexToHash("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421")
// func OpenDatabaseWithFreezer(name string, cache, handles int, freezer, namespace string, readonly bool) (ethdb.Database, error) {
// 	var db ethdb.Database
// 	var err error
// 	db, err = rawdb.NewLevelDBDatabaseWithFreezer(root, cache, handles, freezer, namespace, readonly)
// 	// if err == nil {
// 	// 	db = n.wrapDatabase(db)
// 	// }
// 	retruen db, nil
// }

func disassembler() {
	fmt.Println("######disassembler start######")
	byteCodeStr := "608060405234801561001057600080fd5b5060408051808201909152600a81526912195b1b1bd5dbdc9b1960b21b602082015260009061003f90826100e4565b506101a3565b634e487b7160e01b600052604160045260246000fd5b600181811c9082168061006f57607f821691505b60208210810361008f57634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156100df57600081815260208120601f850160051c810160208610156100bc5750805b601f850160051c820191505b818110156100db578281556001016100c8565b5050505b505050565b81516001600160401b038111156100fd576100fd610045565b6101118161010b845461005b565b84610095565b602080601f831160018114610146576000841561012e5750858301515b600019600386901b1c1916600185901b1785556100db565b600085815260208120601f198616915b8281101561017557888601518255948401946001909101908401610156565b50858210156101935787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6103a4806101b26000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c8063a41368621461003b578063cfae321714610050575b600080fd5b61004e610049366004610126565b61006e565b005b61005861007e565b60405161006591906101d7565b60405180910390f35b600061007a82826102ae565b5050565b60606000805461008d90610225565b80601f01602080910402602001604051908101604052809291908181526020018280546100b990610225565b80156101065780601f106100db57610100808354040283529160200191610106565b820191906000526020600020905b8154815290600101906020018083116100e957829003601f168201915b5050505050905090565b634e487b7160e01b600052604160045260246000fd5b60006020828403121561013857600080fd5b813567ffffffffffffffff8082111561015057600080fd5b818401915084601f83011261016457600080fd5b81358181111561017657610176610110565b604051601f8201601f19908116603f0116810190838211818310171561019e5761019e610110565b816040528281528760208487010111156101b757600080fd5b826020860160208301376000928101602001929092525095945050505050565b600060208083528351808285015260005b81811015610204578581018301518582016040015282016101e8565b506000604082860101526040601f19601f8301168501019250505092915050565b600181811c9082168061023957607f821691505b60208210810361025957634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156102a957600081815260208120601f850160051c810160208610156102865750805b601f850160051c820191505b818110156102a557828155600101610292565b5050505b505050565b815167ffffffffffffffff8111156102c8576102c8610110565b6102dc816102d68454610225565b8461025f565b602080601f83116001811461031157600084156102f95750858301515b600019600386901b1c1916600185901b1785556102a5565b600085815260208120601f198616915b8281101561034057888601518255948401946001909101908401610321565b508582101561035e5787850151600019600388901b60f8161c191681555b5050505050600190811b0190555056fea264697066735822122004957a2054347f8181f8f40fd80c5fcd53272c8d61a0f48df1ec4b18597d595064736f6c63430008110033"
	stateDB, _ := state.New(common.HexToHash("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"))
	evm := vm.NewEVM(stateDB)
	evm.Interpreter().Disassembler(byteCodeStr)
	fmt.Println("######disassembler end######")
}

func createContract() {
	// byteCodeStr := "608060405234801561001057600080fd5b50605560005560e2806100246000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c8063ef5fb05b14602d575b600080fd5b604080518082018252600a8152691a195b1b1bdddbdc9b1960b21b60208201529051605791906060565b60405180910390f35b600060208083528351808285015260005b81811015608b578581018301518582016040015282016071565b506000604082860101526040601f19601f830116850101925050509291505056fea2646970667358221220ed09cf55ba7895ca4cb49da8268e332340bcb8de2af198510c97fd3a2a06f36864736f6c63430008110033"
	byteCodeStr := "608060405234801561001057600080fd5b5060408051808201909152600a81526912195b1b1bd5dbdc9b1960b21b602082015260009061003f90826100e4565b506101a3565b634e487b7160e01b600052604160045260246000fd5b600181811c9082168061006f57607f821691505b60208210810361008f57634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156100df57600081815260208120601f850160051c810160208610156100bc5750805b601f850160051c820191505b818110156100db578281556001016100c8565b5050505b505050565b81516001600160401b038111156100fd576100fd610045565b6101118161010b845461005b565b84610095565b602080601f831160018114610146576000841561012e5750858301515b600019600386901b1c1916600185901b1785556100db565b600085815260208120601f198616915b8281101561017557888601518255948401946001909101908401610156565b50858210156101935787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6103a4806101b26000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c8063a41368621461003b578063cfae321714610050575b600080fd5b61004e610049366004610126565b61006e565b005b61005861007e565b60405161006591906101d7565b60405180910390f35b600061007a82826102ae565b5050565b60606000805461008d90610225565b80601f01602080910402602001604051908101604052809291908181526020018280546100b990610225565b80156101065780601f106100db57610100808354040283529160200191610106565b820191906000526020600020905b8154815290600101906020018083116100e957829003601f168201915b5050505050905090565b634e487b7160e01b600052604160045260246000fd5b60006020828403121561013857600080fd5b813567ffffffffffffffff8082111561015057600080fd5b818401915084601f83011261016457600080fd5b81358181111561017657610176610110565b604051601f8201601f19908116603f0116810190838211818310171561019e5761019e610110565b816040528281528760208487010111156101b757600080fd5b826020860160208301376000928101602001929092525095945050505050565b600060208083528351808285015260005b81811015610204578581018301518582016040015282016101e8565b506000604082860101526040601f19601f8301168501019250505092915050565b600181811c9082168061023957607f821691505b60208210810361025957634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156102a957600081815260208120601f850160051c810160208610156102865750805b601f850160051c820191505b818110156102a557828155600101610292565b5050505b505050565b815167ffffffffffffffff8111156102c8576102c8610110565b6102dc816102d68454610225565b8461025f565b602080601f83116001811461031157600084156102f95750858301515b600019600386901b1c1916600185901b1785556102a5565b600085815260208120601f198616915b8281101561034057888601518255948401946001909101908401610321565b508582101561035e5787850151600019600388901b60f8161c191681555b5050505050600190811b0190555056fea264697066735822122004957a2054347f8181f8f40fd80c5fcd53272c8d61a0f48df1ec4b18597d595064736f6c63430008110033"
	byteCodes, err := hex.DecodeString(byteCodeStr)
	if err != nil {
		fmt.Println("转换失败:", err)
		return
	}
	fmt.Println(byteCodes)
	caller := common.HexToAddress("0xDf40D489563D6040daa47c87Cd785EcE2cB8d4a8")

	fmt.Println("caller address: ", caller)
	fmt.Println("caller address: ", vm.AccountRef(caller).Address())

	stateDB, _ := state.New(common.HexToHash("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"))
	evm := vm.NewEVM(stateDB)
	evm.Create(vm.AccountRef(caller), byteCodes, 0, big.NewInt(0))
}

func call() {
	greet := "cfae3217"
	// greet := "a41368620000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001a68656c6c6f20776f726c642021212068656c6c6f20776f726c64000000000000"
	greetCode, _ := hex.DecodeString(greet)
	caller := common.HexToAddress("0xDf40D489563D6040daa47c87Cd785EcE2cB8d4a8")
	contractAddress := common.HexToAddress("0x54B62465192101eeF3fDC3eD6dde7E2ccbe0F51B")

	stateDB, _ := state.New(common.HexToHash("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"))
	evm := vm.NewEVM(stateDB)
	evm.Call(vm.AccountRef(caller), contractAddress, greetCode, 0, big.NewInt(0))
}

// 0x54B62465192101eeF3fDC3eD6dde7E2ccbe0F51B
func main() {
	fmt.Println("hello world")
	call()
}

// 0x00c00ECab213402e0Bf16e88F61c7f07b2D42Ce3
